<!-- ... existing code ... -->
    <!-- This invisible video loops to keep the iOS processor awake -->
    <video id="wakeLockVideo" playsinline loop muted>
        <source src="data:video/mp4;base64,AAAAHGZ0eXBtcDQyAAAAAG1wNDJpc29tAAAAAAAzbW9vdgAAAABsbXZoAAAAANE8n8AAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAODXRyYWsAAABcdGtoZAAAAAEdAAAPAAAAAAABAAAAAAEAAAAAAAAAAAAAAABAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAMW1kaWEAAAAgbWRoZAAAAADRPJ/AAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABUWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAAB2aWRlb2hhbmRsZXIAAAABZ21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAA5zdGJsAAAAEmN0dHMAAAAAAQAAAAEAAAABAAAAFHN0c3MAAAAAAQAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAABAAAAAQAAABhNZGF0AAAAAAAA" type="video/mp4">
    </video>

    <div id="uploadContainer">
<!-- ... existing code ... -->
        let sentenceToPageMap = [];
        let pageToSentenceMap = [];
        
        // --- BACKGROUND AUDIO HACK VARIABLES ---
        let wakeLockVideo = document.getElementById('wakeLockVideo');
        let backgroundEnabled = false;
        let heartbeatInterval = null;

        // --- 1. ENABLE BACKGROUND AUDIO ---
        function enableBackgroundMode() {
            if (backgroundEnabled) return;
            
            // Start the silent video loop. 
            // iOS requires a user interaction (click) to start this, which happens when you click 'Play'.
            wakeLockVideo.play().then(() => {
                console.log("Wake Lock Video Active");
            }).catch(e => console.log("Wake Lock failed:", e));

            // Set up Media Session API (The Lock Screen Controls)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', () => {
                    togglePlay(true);
                });
                navigator.mediaSession.setActionHandler('pause', () => {
                    togglePlay(false);
                });
                navigator.mediaSession.setActionHandler('previoustrack', () => {
                    navigateSentence(-10);
                });
                navigator.mediaSession.setActionHandler('nexttrack', () => {
                    navigateSentence(10);
                });
            }
            backgroundEnabled = true;
        }

        // Keep the JS thread alive on iOS
        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                // If the system paused us unexpectedly (common iOS bug), force resume
                if (speechSynthesis.paused && isPlaying) {
                    speechSynthesis.resume();
                }
                console.log("Heartbeat active"); 
            }, 3000);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
        }

        function updateMediaSessionMetadata() {
<!-- ... existing code ... -->
        function togglePlay(forceState) {
            if (sentences.length === 0) return;
            
            // Activate the background hacks on first play
            enableBackgroundMode();

            const newState = forceState !== undefined ? forceState : !isPlaying;
            isPlaying = newState;
            
            const btn = document.getElementById('playPauseBtn');
            btn.textContent = isPlaying ? '⏸' : '▶';

            if (isPlaying) {
                startHeartbeat(); // Start the keep-alive timer
                speakSentence(currentSentenceIndex);
                if (navigator.mediaSession) navigator.mediaSession.playbackState = "playing";
            } else {
                stopHeartbeat(); // Stop the keep-alive timer
                speechSynthesis.cancel();
                if (navigator.mediaSession) navigator.mediaSession.playbackState = "paused";
            }
        }

        function navigateSentence(delta) {
<!-- ... existing code ... -->

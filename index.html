<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Audio Player</title>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #121212;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    header {
      padding: 12px 16px;
      background: #181818;
      border-bottom: 1px solid #333;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    header h1 {
      font-size: 20px;
      margin: 0;
    }

    header small {
      font-size: 12px;
      color: #aaa;
    }

    .file-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .file-input-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #1db954;
      color: #000;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }

    .file-input-label span.icon {
      font-size: 18px;
    }

    .file-input-label input {
      display: none;
    }

    .file-name {
      font-size: 12px;
      color: #ccc;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    main {
      flex: 1;
      overflow-y: auto;
      padding: 8px 16px 90px;
    }

    #text-container {
      font-size: 17px;
      line-height: 1.6;
    }

    .sentence {
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
      border-radius: 4px;
      padding: 1px 2px;
    }

    .sentence.current {
      background-color: #1db95433;
      color: #ffffff;
    }

    .sentence + .sentence::before {
      content: " ";
    }

    .hint {
      font-size: 13px;
      color: #999;
      margin-top: 8px;
    }

    .player {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #181818;
      border-top: 1px solid #333;
      padding: 8px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 10;
    }

    .current-preview {
      font-size: 13px;
      color: #ccc;
      min-height: 1.3em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .controls button {
      background: #282828;
      border: none;
      border-radius: 20px;
      padding: 8px 12px;
      font-size: 14px;
      color: #f5f5f5;
      cursor: pointer;
      min-width: 40px;
    }

    .controls button:active {
      transform: scale(0.96);
    }

    #play-pause {
      background: #1db954;
      color: #000;
      font-weight: 600;
      min-width: 80px;
    }

    .extra {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      margin-top: 2px;
    }

    .extra label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .extra input[type="range"] {
      width: 120px;
    }

    .extra select {
      background: #282828;
      color: #f5f5f5;
      border-radius: 6px;
      border: 1px solid #333;
      padding: 3px 6px;
      font-size: 12px;
    }

    @media (min-width: 768px) {
      header h1 {
        font-size: 22px;
      }
      #text-container {
        max-width: 760px;
        margin: 0 auto;
      }
      .extra input[type="range"] {
        width: 160px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>PDF Audio Player</h1>
      <div class="file-row">
        <label class="file-input-label">
          <span class="icon">üìÑ</span>
          <span>Select PDF</span>
          <input id="file-input" type="file" accept="application/pdf" />
        </label>
        <span class="file-name" id="file-name">No file selected</span>
      </div>
      <small>Upload a text-heavy PDF (ebook) and press Play. Tap any sentence to start from there.</small>
    </header>

    <main>
      <div id="text-container">
        <p class="hint">
          Load a PDF to see the text here. The current sentence will be highlighted while it is being read,
          like song lyrics.
        </p>
      </div>
    </main>

    <div class="player">
      <div id="current-sentence-preview" class="current-preview">
        No sentence loaded.
      </div>

      <div class="controls">
        <button id="back10">‚èÆ 10</button>
        <button id="prev">‚óÄ 1</button>
        <button id="play-pause">Play</button>
        <button id="next">1 ‚ñ∂</button>
        <button id="forward10">10 ‚è≠</button>
      </div>

      <div class="extra">
        <label>
          Speed
          <input type="range" id="speed" min="0.7" max="1.4" step="0.1" value="1" />
        </label>
        <label>
          Voice
          <select id="voice-select"></select>
        </label>
      </div>
    </div>
  </div>

  <!-- pdf.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>

  <script>
    // ====== PDF + Text handling ======
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js';

    const fileInput = document.getElementById('file-input');
    const fileNameLabel = document.getElementById('file-name');
    const textContainer = document.getElementById('text-container');
    const currentPreview = document.getElementById('current-sentence-preview');

    const playPauseBtn = document.getElementById('play-pause');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const back10Btn = document.getElementById('back10');
    const forward10Btn = document.getElementById('forward10');
    const speedSlider = document.getElementById('speed');
    const voiceSelect = document.getElementById('voice-select');

    const synth = window.speechSynthesis;
    let voices = [];
    let sentences = [];
    let currentIndex = 0;
    let isPlaying = false;
    let lastHighlightedSpan = null;

    function splitIntoSentences(text) {
      // Clean up whitespace
      const clean = text.replace(/\s+/g, ' ').trim();
      const regex = /[^\.!\?]+[\.!\?]+/g;
      const result = [];
      let match;

      while ((match = regex.exec(clean)) !== null) {
        result.push(match[0].trim());
      }

      const lastIndex = regex.lastIndex;
      if (lastIndex < clean.length) {
        const tail = clean.slice(lastIndex).trim();
        if (tail) result.push(tail);
      }
      return result;
    }

    async function loadPdfFromArrayBuffer(arrayBuffer) {
      const typedArray = new Uint8Array(arrayBuffer);
      const pdf = await pdfjsLib.getDocument(typedArray).promise;

      let fullText = '';

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }

      setupSentences(fullText);
    }

    function setupSentences(text) {
      synth.cancel();
      isPlaying = false;
      playPauseBtn.textContent = 'Play';
      sentences = splitIntoSentences(text).filter(s => s.length > 0);
      currentIndex = 0;
      renderSentences();
    }

    function renderSentences() {
      textContainer.innerHTML = '';
      lastHighlightedSpan = null;

      if (!sentences.length) {
        textContainer.textContent = 'No readable text found in this PDF.';
        currentPreview.textContent = 'No sentence loaded.';
        return;
      }

      sentences.forEach((s, idx) => {
        const span = document.createElement('span');
        span.className = 'sentence';
        span.dataset.index = idx;
        span.textContent = s + ' ';
        span.addEventListener('click', () => {
          currentIndex = idx;
          speakFromIndex(currentIndex);
        });
        textContainer.appendChild(span);
      });

      updatePreview();
      updateHighlight(false);
    }

    function updatePreview() {
      if (!sentences.length) {
        currentPreview.textContent = 'No sentence loaded.';
        return;
      }
      const snippet = sentences[currentIndex] || '';
      currentPreview.textContent =
        'Sentence ' + (currentIndex + 1) + '/' + sentences.length + ': ' +
        snippet.slice(0, 140);
    }

    function updateHighlight(scrollIntoView) {
      if (lastHighlightedSpan) {
        lastHighlightedSpan.classList.remove('current');
      }
      const span = document.querySelector('.sentence[data-index="' + currentIndex + '"]');
      if (span) {
        span.classList.add('current');
        lastHighlightedSpan = span;
        if (scrollIntoView) {
          span.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }

    // ====== Voice handling ======
    function loadVoices() {
      const allVoices = synth.getVoices();
      voices = allVoices.filter(v => v.lang.toLowerCase().startsWith('en'));
      voiceSelect.innerHTML = '';

      if (!voices.length) {
        const opt = document.createElement('option');
        opt.value = '-1';
        opt.textContent = 'System default';
        voiceSelect.appendChild(opt);
        return;
      }

      voices.forEach((v, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = v.name + ' (' + v.lang + ')';
        voiceSelect.appendChild(opt);
      });
    }

    if (typeof speechSynthesis !== 'undefined') {
      loadVoices();
      speechSynthesis.onvoiceschanged = loadVoices;
    }

    function getSelectedVoice() {
      const idx = parseInt(voiceSelect.value, 10);
      if (Number.isNaN(idx) || idx < 0 || idx >= voices.length) return null;
      return voices[idx];
    }

    // ====== Text-to-speech playback ======
    function speakFromIndex(startIndex) {
      if (!sentences.length) return;

      if (startIndex < 0) startIndex = 0;
      if (startIndex >= sentences.length) startIndex = sentences.length - 1;

      currentIndex = startIndex;
      synth.cancel();

      isPlaying = true;
      playPauseBtn.textContent = 'Pause';

      queueSentence();
    }

    function queueSentence() {
      if (!isPlaying) return;

      if (currentIndex < 0 || currentIndex >= sentences.length) {
        isPlaying = false;
        playPauseBtn.textContent = 'Play';
        return;
      }

      const raw = sentences[currentIndex];
      const text = raw.trim();
      if (!text) {
        currentIndex++;
        queueSentence();
        return;
      }

      updatePreview();
      updateHighlight(true);

      const utter = new SpeechSynthesisUtterance(text);
      const voice = getSelectedVoice();
      if (voice) utter.voice = voice;

      // Speed control
      utter.rate = parseFloat(speedSlider.value) || 1.0;

      // When one sentence finishes, wait a short time, then speak the next one.
      utter.onend = function () {
        if (!isPlaying) return;
        currentIndex++;
        setTimeout(queueSentence, 200); // ~200 ms pause between sentences
      };

      synth.speak(utter);
    }

    // ====== UI events ======
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      fileNameLabel.textContent = file.name;

      const reader = new FileReader();
      reader.onload = (ev) => {
        loadPdfFromArrayBuffer(ev.target.result);
      };
      reader.readAsArrayBuffer(file);
    });

    playPauseBtn.addEventListener('click', () => {
      if (!sentences.length) return;

      if (!isPlaying) {
        // Start / resume
        if (synth.paused && synth.speaking) {
          isPlaying = true;
          playPauseBtn.textContent = 'Pause';
          synth.resume();
        } else {
          speakFromIndex(currentIndex);
        }
      } else {
        // Pause
        isPlaying = false;
        playPauseBtn.textContent = 'Play';
        synth.pause();
      }
    });

    prevBtn.addEventListener('click', () => {
      if (!sentences.length) return;
      currentIndex = Math.max(0, currentIndex - 1);
      speakFromIndex(currentIndex);
    });

    nextBtn.addEventListener('click', () => {
      if (!sentences.length) return;
      currentIndex = Math.min(sentences.length - 1, currentIndex + 1);
      speakFromIndex(currentIndex);
    });

    back10Btn.addEventListener('click', () => {
      if (!sentences.length) return;
      currentIndex = Math.max(0, currentIndex - 10);
      speakFromIndex(currentIndex);
    });

    forward10Btn.addEventListener('click', () => {
      if (!sentences.length) return;
      currentIndex = Math.min(sentences.length - 1, currentIndex + 10);
      speakFromIndex(currentIndex);
    });

    speedSlider.addEventListener('input', () => {
      // New speed will apply to the next sentences automatically.
    });
  </script>
</body>
</html>
